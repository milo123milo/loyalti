<link rel="stylesheet" href="/stylesheets/header.css" />
<link rel="stylesheet" href="/stylesheets/users.css" />
<link rel="stylesheet" href="/stylesheets/bootstrap.min.css" />
    <link rel="stylesheet" href="/stylesheets/fonts.css" />

<script src="https://unpkg.com/gridjs/dist/gridjs.umd.js"></script>

<script src="https://code.jquery.com/jquery-3.6.4.min.js
" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js"
    integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
    crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js"
    integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
    crossorigin="anonymous"></script>

<link href="https://unpkg.com/gridjs/dist/theme/mermaid.min.css" rel="stylesheet" />
<style>
    .itemfield {
        margin-right: 10px;
    }
    .input-row {
        display: flex;
        width: 60%;
        margin-bottom: 10px;
    }
    .hide {
        display: none ;
    }
    .modal-body{
        display: flex;
    align-items: center;
    justify-content: center;
        margin-block: 19px;
    }
    .modal-dialog {
            max-width: 73px !important;
    }
    *{padding:0;margin:0}.wrapper{display:flex;justify-content:center;align-items:center;}.checkmark__circle{stroke-dasharray: 166;stroke-dashoffset: 166;stroke-width: 2;stroke-miterlimit: 10;stroke: #7ac142;fill: none;animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards}.checkmark{width: 32px;height: 32px;border-radius: 50%;display: block;stroke-width: 2;stroke: #fff;stroke-miterlimit: 10;margin: 10% auto;box-shadow: inset 0px 0px 0px #7ac142;animation: fill .4s ease-in-out .4s forwards, scale .3s ease-in-out .9s both}.checkmark__check{transform-origin: 50% 50%;stroke-dasharray: 48;stroke-dashoffset: 48;animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards}@keyframes stroke{100%{stroke-dashoffset: 0}}@keyframes scale{0%, 100%{transform: none}50%{transform: scale3d(1.1, 1.1, 1)}}@keyframes fill{100%{box-shadow: inset 0px 0px 0px 30px #7ac142}}


.checkmarkx {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  display: block;
  stroke-width: 2;
  stroke: #fff;
  stroke-miterlimit: 10;
  box-shadow: inset 0px 0px 0px #d02a35;
  animation: fillx .4s ease-in-out .4s forwards, scale .3s ease-in-out .9s both;
}

.checkmark_circlex {
  stroke-dasharray: 166;
  stroke-dashoffset: 166;
  stroke-width: 2;
  stroke-miterlimit: 10;
  stroke: #d02a35;
  fill: none;
  animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
}

.checkmark_checkx {
  transform-origin: 50% 50%;
  stroke-dasharray: 48;
  stroke-dashoffset: 48;
  animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards;
}

@keyframes stroke {
  100% {
    stroke-dashoffset: 0;
  }
}
@keyframes scale {
  0%, 100% {
    transform: none;
  }
  50% {
    transform: scale3d(1.1, 1.1, 1);
  }
}
@keyframes fillx {
  100% {
    box-shadow: inset 0px 0px 0px 30px #d02a35;
  }
}
.forma {
    display: flex;
    align-items: flex-end;
}
.form-group {
    margin-right: 20px;
    margin-bottom: 0 !important;
}
.formbtn {
    height: calc(1.5em + 0.75rem + 2px) !important; 
}
.title-items {
    margin-bottom: 10px;
}
.btn-trash {
         color: #dc3545 !important;
         background-color: #fff !important;
         border-color: #fff !important;
      
 }
</style>


<div class="header">
    <div class="h1">
    <%= __('input.input')%>
    </div>
    <div class="head-left">

        <button onclick="window.history.back()" style="margin-bottom: 4px;" id="logout-button" type="button"
            class="bt btn btn-primary">
            <%= __('input.back')%></button>
    </div>
</div>
<div class="modal fade in" id="exampleModalCenter" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenter"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header1">
            </div>
            <div class="modal-body">
                <div id="doneError" class="">
                    <svg class="checkmarkx" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                        <circle class="checkmark_circlex" cx="26" cy="26" r="25" fill="none" />
                        <path class="checkmark_checkx" fill="none" d="M14.1 14.1l23.8 23.8 m0,-23.8 l-23.8,23.8" />
                    </svg>
                </div>
                <div id="doneCheck" class=""> <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                        <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none" />
                        <path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8" />
                    </svg>
                </div>
                
                    <div id="spiner" class="spinner-border text-secondary" role="status">
                        <span class="sr-only">Loading...</span> 
                    </div>
            </div>
            <div class="modal-footer1">

            </div>
        </div>
    </div>
</div>

<div class="content" style="margin-block: 35px !important;">

    <form class="forma" id="inputForm" >
        <div class="form-group">
            <label for="receipt"><%= __('input.receipt')%></label>
            <input onkeyup="autoTab(event)" type="text" name="receipt" class="form-control" id="receipt" placeholder="Scan QR Code" >

        </div>
        <div class="form-group">
            <label for="loyaltycard"><%= __('input.card')%></label>
            <input type="text" name="card" class="form-control" id="loyaltycard" placeholder="Scan QR Code" required="true">
        </div>
        <button id="submit"  class="btn btn-primary formbtn"><%= __('input.submit')%></button>
    </form>
    
    
</div>
<div style="margin-inline: 100px;">
    <form id="myForm"></form>
    <button style="margin-top: 10px;" id="addButton" class="btn btn-success"><%= __('input.add')%></button>
</div>


<script>
    
    document.getElementById('receipt').focus();
    /*
    function autoTab(event) {
            
            const input = event.target;
            if (input.value.length >= input.maxLength) {
                
                document.getElementById('loyaltycard').focus();
            }
        }*/
    const check = document.getElementById('doneCheck');
    const cross = document.getElementById('doneError');
    const spiner = document.getElementById('spiner');
    const modal = document.getElementById('exampleModalCenter');
    //divElement.classList.add('wrapper');
    

    
    const submitBtn = inputForm.querySelector("button[id='submit']");
    
    submitBtn.addEventListener("click", function (event) {
        const form = document.getElementById('inputForm');
        const itemsform = document.getElementById("myForm");
        console.log(itemsform, itemsform.reportValidity())
        console.log(form, form.reportValidity())
        
        
        
        
        if (form.reportValidity() === false) {
            console.log('false111')
            check.classList.add('hide');
            spiner.classList.add('hide')

            $('#exampleModalCenter').modal('hide');

            event.preventDefault();
            return
        }
        if (itemsform.reportValidity() === false) {
            console.log("false2222")
            check.classList.add('hide');
            spiner.classList.add('hide')

            $('#exampleModalCenter').modal('hide');

            event.preventDefault();
            return
        }
        
        $('#exampleModalCenter').modal('show');
        
        // Close the modal
        // Example: add event listener to a close button inside the modal
        
        
        check.classList.add('hide');
        cross.classList.add('hide')
        spiner.classList.remove('hide')
        event.preventDefault(); // prevent default form submission behavior
        
        // get the form data
        const input = {}
        input.receipt = document.getElementById("receipt").value;
        input.card = document.getElementById("loyaltycard").value;
        input.extraItems =  getValues() 
        
        input.noreceipt = false
        if(input.receipt === ''){
            input.noreceipt = true
        }
        

        

        console.log("Data:" + JSON.stringify(input))

        
        
        // send the form data to the server using fetch
        //myModal.toggle();
        
        fetch('/checkBill', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(input)
        })
            .then(response => {
                if (response.status == 200) {
                    spiner.classList.add('hide');
                    check.classList.remove('hide');
                    check.classList.add('wrapper');

                    check.addEventListener('animationend', function () {
                        // Animation is finished, do something here
                        setTimeout(function () {
                            $('#exampleModalCenter').modal('hide');
                            check.classList.add('hide')
                            check.classList.remove('wrapper')
                        }, 1200);
                    });
                    console.log('Form submitted successfully');
                }
                if (response.status != 200) {
                    
                    spiner.classList.add('hide');
                    cross.classList.remove('hide');
                    cross.classList.add('wrapper');

                    cross.addEventListener('animationend', function () {
                        // Animation is finished, do something here
                        setTimeout(function () {
                            $('#exampleModalCenter').modal('hide');
                            cross.classList.add('hide')
                            cross.classList.remove('wrapper')
                        }, 1200);
                    });
                    if (response.status == 501) {
                        alert("Clients Loyalty card not found!")
                    } else if (response.status == 500) {
                        alert("Duplicate receipt! This receipt already exist.")
                    } else {
                     //   alert("Failed submission!")
                    }

                }
                
            })
            .catch(error => {
                spiner.classList.add('hide');
                cross.classList.remove('hide');
                cross.classList.add('wrapper');

                cross.addEventListener('animationend', function () {
                    // Animation is finished, do something here
                    setTimeout(function () {
                        $('#exampleModalCenter').modal('hide');
                        cross.classList.add('hide')
                        cross.classList.remove('wrapper')
                    }, 1200);
                });
                console.log('Failed submission!');
                console.error('Error submitting form:', error);
            });

            inputForm.reset();
            return
        
    });



        var form = document.getElementById("myForm");
            var addButton = document.getElementById("addButton");
            var inputCount = 0;
            var titleCreated = false
            

            addButton.addEventListener("click", function () {
                var inputRow = document.createElement("div");
                
                

                
                inputRow.className = "input-row";
                const holders = ["<%= __('input.items.name')%>", "<%= __('input.items.unit')%>", "<%= __('input.items.quanity')%>", "<%= __('input.items.unitprice')%>", "vatRate"]
                for (var i = 0; i < 5; i++) {
                    var input = document.createElement("input");
                    input.name = "item" + inputCount;
                    input.id = "input" + inputCount
                    input.placeholder = holders[i]
                    input.classList.add('form-control', 'itemfield')
                    input.setAttribute('required', 'true')
                    inputRow.appendChild(input);
                    if(i === 4){
                        input.value = '21'
                        input.disabled = true
                    }
                    inputCount++;

                }
                const button = document.createElement('Button');
                button.classList.add('btn', 'btn-trash')
                button.textContent = '✖'
                button.onclick
                button.addEventListener('click', function () {
                    const parentDiv = button.parentNode;
                    parentDiv.remove();
                });
                if(titleCreated === false) {
                    var title = document.createElement("div");
                    title.className = 'title-items'
                    title.textContent = '<%= __('input.additional')%>'
                    form.appendChild(title);
                }
                form.appendChild(inputRow);
                inputRow.appendChild(button)
                titleCreated = true
                
            });

            function getValues() {
                
                var inputRows = document.getElementsByClassName("input-row");
                var values = [];
                var sumNoVat = 0
                var sumWithVat = 0

                for (var i = 0; i < inputRows.length; i++) {
                    
                    var inputs = inputRows[i].getElementsByTagName("input");
                    var rowValues = {};
                    var fieldNames = ['id' ,'name', 'unit', 'quantity', 'unitPriceBeforeVat', 'vatRate', "priceBeforeVat", 'priceAfterVat']

                    
                    for (var j = 0; j < inputs.length; j++) {
                        rowValues[fieldNames[j+1]] = inputs[j].value;
                    }
                    rowValues[fieldNames[0]] = '133310' + i
                    rowValues[fieldNames[6]] = rowValues[fieldNames[3]] * rowValues[fieldNames[4]]
                    rowValues[fieldNames[7]] = rowValues[fieldNames[6]] + (rowValues[fieldNames[6]] / 100) * rowValues[fieldNames[5]]
                    sumNoVat = sumNoVat + rowValues[fieldNames[6]]
                    sumWithVat = sumNoVat + (sumNoVat / 100) * rowValues[fieldNames[5]]

                    if(rowValues[fieldNames[1]]  !== '' && sumNoVat > 0){
                        values.push(rowValues);
                    }
                    
                }
                var status = false
                if (sumNoVat > 0){
                    status = true
                }
                var receiptElement = document.getElementById('receipt');
                
                
                form.reportValidity()
                console.log({items: values, sumNoVat, sumWithVat, status }); // Do whatever you want with the values
                return { items: values, sumNoVat, sumWithVat, status };
            }

            $('#exampleModalCenter').on('hide.bs.modal', function (e) {
                    $(".input-row").remove();
                    $(".title-items").remove();
                    titleCreated = false
                    
                });
           
</script>
